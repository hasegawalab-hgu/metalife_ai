# Gather_Lab（仮称）
更新履歴  
2025年 2月14日 by 長井（偉大な初代開発者！！！！）  
  

## 使用ツール
- Unity 2022.3.24 （できるだけこのバージョンをダウンロードするように、もし必要性を感じたらUnity6にするのもあり）
- Photon Fusion2 （無料プラン）
- PlayFab （無料プラン）
- ChatGPT-4o （最新で無料のものがあればモデル変更してみるといいよ）

## このツールについて
このツールはオフラインプレイヤーをAIで制御して活性化させたバーチャルオフィスである。  
参考にしたバーチャルオフィスのサイトは[Gather.io](https://ja.gather.town/)と[MetaLife](https://metalife.co.jp/)で、ログインやチャット、キャラクターの移動、変更など基本的な機能を実装してある。  
AIアバターの行動生成はステート遷移をするルールベースで制御している。  
AIアバターの対話応答の生成はChatGPT-4oのAPI機能で実装しており、DMの内容（jsonまんま）+ プロンプト + 送信した内容を全てChatGPTに送ることで実装している。  
  
このプロジェクトは少し規模が大きめなので絶対に[unity拡張機能を導入したvscode](https://zenn.dev/iwatos/articles/6a19af30e4cad7)とgitを使用することをおすすめする。ちなみにgitに関してはgit-lfsというツールも使用して大きめのデータも保存できるようにしているため、gitだけでは管理できない。  

## 注意点
- 開発者のMac環境はM3なのでIntel系Macを使用の場合は環境構築中にエラーが起こる可能性がある
- ChatGPTのAPIキーは現在デバイスに保存する方法をとっているため、別のPCから同じアカウントへログインする際は再度APIキーを入力する必要がある
- ChatGPTに関わらず発行したAPIキーはgithubにpushしないこと（プライベートリポジトリやfeatureブランチであっても含めないようにすること）
- 2025/02/14現在はアカウント新規作成画面で卒業年度を`2025`と入力しないとルーム選択ボタンが現れない。  
- 2025/02/14現在は`Assets/ScriptableObjects/Lobby.asset`の`Name`を`Hasegawa_lab_2024`と固定にしているので別のルームに入ったとしてもphotnnのサーバーは同じになってまう...
  
## プロジェクトファイルのダウンロード方法（macの場合）
  
### [homebrewインストール](https://brew.sh/ja/)

### git インストール
```
brew install git
```

### git-lfs インストール
```
brew install git-lfs
```

### プロジェクトファイルダウンロード（githubにリポジトリがある場合）
```
git clone <リポジトリ>
```
### PhotonFusion初期設定
unityでプロジェクトを開いて、上部の`Tools`ボタンから`Fusion`、`Fusion Hub`を開いて
```
b869acae-afde-47de-9b3e-d714e90d79f6
```
を入力（これは今後環境変数から取得するようにした方がいいかも）

### Playfab初期設定
unityの上部の`PlayFab`ボタンを押して、`MakePlayFabSharedSettings`を開く  
`Title Id`に

```
35895
```
を入力（これは今後環境変数から取得するようにした方がいいかも）

### zipファイル解凍（githubにリポジトリがなく、zipファイルを渡された場合）
先生からもらったzipファイルをワーキングディレクトリ（テキトーに作って）で解凍
```
cd Gather_Lab
```
```
git init
git lfs install
```

## 共同開発や複数PCを使用する場合
gitだけでなくgithubにリポジトリを上げて管理することをおすすめする。（リポジトリはpublicではなくprivateで管理！）  
main → develop → feature のように管理して、機能ごとにdevelopからfeatureブランチを作成し、それをdevelopにmergeする方法が楽だし管理しやすい。  

※ この時featureブランチで明らかなバグが残っているままmergeしないでください、本当にお願いします。通信を使用したシステムなのでデバッグ大変なんですお願いします。（まあrevertすればいいんだけどね）

### リモートリポジトリ作成
https://github.com/new でリモートリポジトリの作成ができる。  
この時以下の点に注意すること。  

- 必ずprivateリポジトリにすること（publicだと公開されてしまう）
- readmeや.gitignoreを新規作成しないこと（どちらもすでにこのプロジェクトにある）

### github ssh接続
ssh接続しなくてもリモートリポジトリと接続できるが毎回パスフレーズを入力しなければいけないので基本することをお勧めする。  
https://prog-8.com/docs/git-env などの好きな方法でやればいい。

## PlayFab操作方法
### ログイン、タイトルの選択
- https://developer.playfab.com/ja-jp/35895/dashboard でタイトルにアクセスする
    - playfabは先生のアカウントで運用しているのでログインする時はID:`hasegawa.lab.hgu@gmail.com` pasword:`Nod.....`（passは先生に聞いて）でログインできる
### プレイヤーデータ
- [プレイヤー画面](https://developer.playfab.com/ja-jp/r/t/35895/players)で検索ボタンを押すと全プレイヤーが確認できる。(nagai_kantaは消さないで泣)
- [ユーザーデータ](https://developer.playfab.com/ja-jp/r/t/35895/players/628BC9DC7EBAD21F/data)はプレイヤーを選択し、`プレイヤーデータ（タイトル）` を押すと閲覧できる
    - キャラクターのpathとかが見れるよ
### 共有グループデータ
- [共有グループデータ](https://developer.playfab.com/ja-jp/35895/shared-group-data)を押し、ルーム名（hasegawa_lab_2024）などを入力すると閲覧できる
    - プレイヤー一覧（adminは除く）
    - チャンネル一覧（DMは除く）
    - チャンネルの中身
    - DM（playfabid + playfabid）の中身
    などが閲覧できるよ

## 起動方法
### playfabルーム作成（初回のみ）
- https://developer.playfab.com/ja-jp/35895/shared-group-data で好きな名前のルーム名を入力
- `Lab_Admin`という既存のプレイヤーを追加
- 共有グループデータを保存

### アプリ起動
- アプリをビルドし、.appファイルを起動する
- ログイン、またはアカウントの新規作成をする
    - 初回のみログイン画面が2回現れる
    - テストアカウントのログイン方法は  
    id:`test`  
    pass:`testtest`（テストアカウントは全てpassが`testtest`だった気がする）  

<details>
<summary>“悪質なソフトウェアかどうかをAppleでは確認できないため、このソフトウェアは開けません。”
と表示された場合...</summary>
1. macOSデスクトップ左上のアップルメニューより［システム環境設定］-［セキュリティとプライバシー］をクリック<br>
2. 画面下「ダウンロードしたアプリケーションの実行許可」より「このまま開く」をクリック<br>
3. 再度アプリを起動する
</details>

## 操作方法
- AWSDで移動
- 上下キーで会話対象の変更（赤枠が会話対象、緑枠は3マス以内の会話対象の候補）
- ESCキーでログ画面の開閉
- ログ画面のチャンネルボタンとDMボタンでその人との会話履歴を見れる
- ログ画面のキャラクターボタンを押し、好きなキャラを選択してokボタンを押すとキャラクター変更（戻る時はreturnボタン）
- DMは会話対象の近くで文章をEnterを入力することで送信（カーソルを文末にしてからEnterを押さないと送信できない）
- スタンプはボタンを押せば送信できる（全員に表示されるが、通知音がなるのは会話対象だけ）
- tab で入力をフォーカス、何も文字を入力してない状態で Enterでフォーカスを外す

## デバッグ方法
### リアルタイム通信関係をいじった場合  
毎回ビルドするか別のPCでfeatureブランチをgit pullするしかないからまじつらい、発狂する
### リアルタイム通信以外の変更
ビルドしなくてもできるよ！！！！！


## 実装して欲しい機能一覧
- ルーム選択画面
    - ユーザーデータに登録しているルーム名を保存
    - ログイン後の画面でユーザーデータに登録されているルームのボタンを表示
    - inputfieldにルーム名を入力して新規ルーム作成 or 作成済みだが入ったことのないルームに接続（playfabのunitySDKはclientAPIしか使用できないようになっているのでcloudscriptをダッシュボードに登録してそれをunityから呼ぶしか実装方法がない）
- サーバー名変更
    - photonのセッション名を選択したルームと同じ名前にすればいい
- 会議室実装
    - 会議室内でそのメンバー全員にチャットを送信（チャンネル作成とチャンネルへのチャットは実装してあるのでそれ使用して）
- PCの実装
    - PCに座ったら着席のステータスを表示
    - PCの画面を開いて、カレンダーやメモ、ステータス（休憩中など）の変更、全体チャット（通知音なし）ができる
- 全体チャット
    - マップにマイク（メガホン）を設置し、それを使用すると全体チャンネルへのチャット（通知音あり）が送信される
- Slack連携
    - 1人目のルームに入ったオンラインプレイヤーならばSlackに「〜〜が****ルームにログインしました！」と送信
- 招待機能
    - slackかメール登録しているメルアドを使用してルームに招待
- webGL対応
    - UIの変更
    - TextMeshProがwebGLに対応していないので修正（なんかそのエラーを解決するアセットがあるらしい）
- リファクタリング
    - 使っていないメソッドやファイルがたくさんあるのと何もファイル構成を決めていないので管理しやすくして欲しい
- 会話対象の候補者全員にチャット送信
    - ボタンを押すと緑枠のプレイヤーたちが赤枠に変化し、その人たち全員（3マス以内の人）にDMを送りたい
    - 実行した時に
- マウスで会話対象選択
    - 上下キーだけでなくマウスでプレイヤーを選択したら会話対象（赤枠）にする
    - shiftキーを押しながら複数プレイヤー選択するとそのプレイヤー全員を会話対象にし、一斉に同じ内容のDMを送れるようにする
- 音声通信機能
    - 会議室のみ実装なら良さそう
- 画像送信機能
    - ここまで来るとawsを使用した方が良さそう
    - playfabでもストレージサービスがあるみたいだけど容量制限が厳しい
- 映像通信機能
    - 一応API使用すればどうにかなりそう？
- ホワイトボード
    - マップにホワイトボードを設置し、マウスで絵や文字が描ける
    - どうやってそれを保存するかが鍵、ホワイトボードの画質が荒くなるけど2次元配列を使用してそれをそのままjsonでplayfabに保存すれば実装できそう。同時にphotonでも変更箇所のindexと値を送らなきゃいけないから注意。
- UI整備
    - PCの画面比率によってUIがくずれることがあるので直して欲しい
    - チャットの文字が見にくいので直して欲しい
    - 遠くの人が会話していることがわかる（内容は分からなくていい）
- config追加
    - 音声や名前、APIの変更画面の追加

## Q & A
2025/02/14現在は初代開発者しかこのプロジェクトの中身を理解していないので私に聞いてください。暇だったら回答します。

https://gist.github.com/ahaha88/4f4c68cb4e3e054c6da2a5e2a1612c31

### 想定される質問
**Q: ルームに接続できません**  
A: playfabでルームを作成していないのが原因です。もしくは学校のWifiのようにセキュリティーが厳しい（使用しているportが通常と異なる）ネットワーク環境だとうまく接続できないことがあります。  
また、photonの同時接続人数は20人までなので同時にログインするのを避けるか、今後もその人数以上の使用が想定される場合は先生にお願いして課金してもらいましょう。  
頑張って解決して。
  
**Q:別のルームのプレイヤーと接続されてしまいます**  
A: 2025/02/14現在はphotonの接続先（セッション名）が全て固定になっています。  
`Assets/ScriptableObjects/Lobby.asset`のNameという値をplayfabの共有グループデータの名前と統一すれば大丈夫です。  
頑張って実装して。
  
**Q: たまに会話対象が3マス以内にいるのに選択できなくなります**  
A: 2025/02/14現在に存在するバグです。  
頑張って直して。

**Q: APIキーを変更したいです**
A: 現在はunityのPreyerPrefsという機能を使ってローカルに保存しています。「PreyerPrefs」で検索して値の変更方法を調べてください。どうせなら変更ボタンを追加して欲しい。  
頑張って実装して。

**Q: UIが汚くて見づらいです。Windowsで開くと崩れてます**  
A: UIに時間割く暇がありませんでした。もう一人の開発者にお願いしようとしたけど。私の汚いソースコードを読みたくなかったようです...  
頑張って実装して。

**Q: ソースコードが汚くて読みにくいです。どうにかなりませんか**  
A: このプロジェクトはモチベ最悪な中（本当はオタマトーンの開発もやりたかった）期間に追われ、スピード重視で開発したものです。  
正直これを読んでいるあなたのために作ろうとか思ってないわけですよ。  
頑張ってリファクタリングして。

**Q: ビルドしたアプリが重すぎます**  
A: 使用しているSDKが多いことが原因だと思います。メモリの使用率とか見てビビりますよね、わかります。  
頑張って直して。

**Q: ユーザーを作成しようとすると、エラーになります。**  
A: もしログイン画面のソースコード変更したならcomitを戻してください。  
ソースコードを変更していないならユーザーの上限（1タイトル100人まで）を突破した可能性があります。テストアカウントを削除するか、先生にお願いしてplayfabの課金をしましょう。  
頑張って直して。

